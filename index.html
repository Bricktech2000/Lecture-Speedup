<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecture Speedup</title>
  </head>
  <body>
    <input type="file" class="fileInput" />
    <div class="playbackRate">&nbsp;</div>
    <div class="videoDuration">&nbsp;</div>
    <script>
      //copy to zoom recording
      const zoom = () => {
        window.video = document.getElementsByTagName('video')[0];
        window.playbackRate = document.createElement('div');
        document.body.appendChild(playbackRate);
        playbackRate.style.color = 'red';
        playbackRate.style.position = 'absolute';
        playbackRate.style.left = '0';
        playbackRate.style.top = '0';
        window.videoDuration = document.createElement('div');
        document.body.appendChild(videoDuration);
        videoDuration.style.color = 'red';
        videoDuration.style.position = 'absolute';
        videoDuration.style.left = '10em';
        videoDuration.style.top = '0';
      };

      //local code
      const fileInput = document.querySelector('.fileInput');
      const playbackRate = document.querySelector('.playbackRate');
      const videoDuration = document.querySelector('.videoDuration');
      const video = document.createElement('video');

      // https://stackoverflow.com/questions/30424121/get-blob-image-from-file-input-using-jquery/30424172
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        const source = document.createElement('source');
        e.target.files = null;
        const reader = new FileReader();
        // video.controls = true;
        // https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL
        source.src = URL.createObjectURL(file);
        video.appendChild(source);
        document.body.appendChild(video);
        console.log(file);
      };

      //copy to zoom recording or webpage
      const multiplier = Math.pow(2, 1 / 3);
      const maxPow = 12;
      const mulPow = 6;

      const updatePlaybackRate = (rateMultiplier) => {
        const newRate = video.playbackRate * rateMultiplier;
        video.playbackRate = Math.min(
          Math.max(newRate, Math.pow(multiplier, -maxPow) + 0.000000001),
          Math.pow(multiplier, maxPow) - 0.000000001
        );
        playbackRate.textContent =
          'Playback Rate: ' + video.playbackRate.toFixed(2) + 'x';
      };
      updatePlaybackRate(1);
      const killEvent = (e) => {
        // https://stackoverflow.com/questions/19469881/remove-all-event-listeners-of-specific-type
        // https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
      };

      window.addEventListener(
        'keydown',
        (e) => {
          switch (e.code) {
            case 'ShiftRight':
              if (video.paused || video.ended) video.play();
              else video.pause();
              killEvent(e);
              break;
            case 'ArrowUp':
              e.preventDefault();
              updatePlaybackRate(Math.pow(multiplier, 1));
              killEvent(e);
              break;
            case 'ArrowDown':
              e.preventDefault();
              updatePlaybackRate(Math.pow(multiplier, -1));
              killEvent(e);
              break;
            case 'ArrowLeft':
              e.preventDefault();
              // https://stackoverflow.com/questions/32654074/how-to-make-a-video-jump-back-to-the-start-after-it-ends-using-javascript?noredirect=1&lq=1
              video.currentTime = video.currentTime - 5;
              killEvent(e);
              break;
          }
        },
        true
      );

      window.addEventListener(
        'keydown',
        (e) => {
          if (e.code == 'ArrowRight') {
            // https://stackoverflow.com/questions/6087959/prevent-javascript-keydown-event-from-being-handled-multiple-times-while-held-do
            killEvent(e);
            if (!e.repeat) updatePlaybackRate(Math.pow(multiplier, mulPow));
          }
        },
        true
      );

      window.addEventListener(
        'keyup',
        (e) => {
          if (e.code == 'ArrowRight') {
            killEvent(e);
            if (!e.repeat) updatePlaybackRate(Math.pow(multiplier, -mulPow));
          }
        },
        true
      );

      setInterval(() => {
        videoDuration.textContent =
          'Progress: ' +
          ((video.currentTime / video.duration) * 100).toFixed(0) +
          '%';
      }, 100);
    </script>
  </body>
</html>
